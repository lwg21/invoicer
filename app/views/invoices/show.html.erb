<% if @invoice.issued? %>
  <button onclick="window.print()" class="no-print">Print</button>
<% else %>
  <%= link_to "Issue", issue_invoice_path(@invoice), class: "no-print", data: { turbo_method: :patch, turbo_confirm: "Are you sure?" } %>
  <%= link_to "Delete draft", invoice_path(@invoice), class: "no-print", data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %>
<% end %>
<%= link_to "Back to invoices", root_path, class: "no-print" %>

<div id="invoice-header">
  <div class="debug-grey">
    <div><%= @client.designation %></div>
    <div><%= [@client.address_line1, @client.address_line2].compact_blank.join(", ") %></div>
    <div><%= "#{@client.postal_code} #{@client.city}" %></div>
    <div><%= @client.country %></div>
  </div>
  <div class="debug-grey align-right">
    <div><%= Current.user.company.designation %></div>
    <div><%= [Current.user.company.address_line1, Current.user.company.address_line2].compact_blank.join(", ") %></div>
    <div>Telefon: <%= Current.user.company.phone_number %></div>
    <div>E-Mail: <%= Current.user.company.email_address %></div>
  </div>
</div>

<%= turbo_frame_tag dom_id(@invoice) do %>

  <% unless @invoice.issued? %>
    <%= form_for (params[:edit_item] ? @invoice_item : [@invoice, @invoice_item]) do |f| %>
      <div>Description: <%= f.text_field :name %></div>
      <div>Date: <%= f.date_field :date %></div>
      <div>Amount: <%= f.number_field :quantity %></div>
      <div>Price: <%= f.number_field :unit_price %></div>
      <div>Total: <%= number_to_currency(0, unit: "€", format: "%n %u", separator: ",", delimiter: " ") %></div>
      <% if params[:edit_item] %>
        <div><%= f.submit "Edit" %> <%= link_to "Cancel", invoice_path(@invoice) %></div>
      <% else %>
        <div><%= f.submit "Add" %></div>
      <% end %>
    <% end %>
  <% end %>

  <div>
    <% if @invoice.issued? %>
      <h3>RECHNUNG Nr. <%= @invoice.number %></h3>
      <h3>Datum: <%= @invoice.date %></h3>
    <% else %>
      <h3>RECHNUNG DRAFT (invoice not yet issued)</h3>
      <h3>Datum: …</h3>
    <% end %>
  </div>

  <table>
    <thead>
      <th>#</th>
      <th>Beschreibung</th>
      <th>Datum</th>
      <th class="align-right">Anzahl</th>
      <th class="align-right">Einzelpreis</th>
      <th class="align-right">Gesamtpreis</th>
      <% unless @invoice.issued? %>
        <th>Actions</th>
      <% end %>
    </thead>
    <tbody>
      <% @invoice.invoice_items.order(:position).each do |item| %>
        <tr>
          <td><%= "#{item.position}." %></td>
          <td><%= item.name %></td>
          <td><%= item.date %></td>
          <td class="align-right"><%= item.quantity %></td>
          <td class="align-right"><%= number_to_currency(item.unit_price, unit: "€", format: "%n %u", separator: ",", delimiter: " ") %></td>
          <td class="align-right"><%= number_to_currency(item.total_price, unit: "€", format: "%n %u", separator: ",", delimiter: " ") %></td>
          <% unless @invoice.issued? %>
            <td>
              <%= link_to move_invoice_item_path(item, direction: "up"), data: { turbo_method: :patch } do %>
                <%= image_tag "up.svg" %>
              <% end %>
              <%= link_to move_invoice_item_path(item, direction: "down"), data: { turbo_method: :patch } do %>
                <%= image_tag "down.svg" %>
              <% end %>
              <%= link_to duplicate_invoice_item_path(item), data: { turbo_method: :post } do %>
                <%= image_tag "copy.svg" %>
              <% end %>
              <%= link_to invoice_path(@invoice, edit_item: item) do %>
                <%= image_tag "edit.svg" %>
              <% end %>
              <%= link_to invoice_item_path(item), data: { turbo_method: :delete } do %>
                <%= image_tag "trash.svg" %>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h3 class="align-right">Rechnungsbetrag: <%= number_to_currency(@invoice.total, unit: "€", format: "%n %u", separator: ",", delimiter: " ") %></h3>
<% end %>


<div>
  Lehrtätigkeit im Fach: X
</div>
<div>
  Der ausgewiesene Betrag enthält keine Umsatzsteuer. Umsatzsteuerbefreiung gemäß § 4 Nummer 21 b
  Umsatzsteuergesetz.
</div>
<div>
  Ich bitte Sie den Rechnungsbetrag auf mein unten angegebenes Konto zu überweisen.
  Bitte geben Sie die Rechnungsnummer als Verwendungszweck an.
</div>
<div>
  IBAN: <%= @invoice.company.iban %> BIC: <%= @invoice.company.bic %>
</div>
<table>
  <tbody>
    <td>Gerichsstand: <%= @invoice.company.jurisdiction %></td>
    <td>Steuer-Nr.: <%= @invoice.company.vat_number %></td>
  </tbody>
</table>
